<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- PRODUCTION FIX: Ultra aggressive verification detection -->
    <script>
        // Run this immediately, at the highest priority
        (function() {
            try {
                console.log('🔴 PRODUCTION-FIX: Running ultra aggressive verification check');
                var url = window.location.href;
                var pathname = window.location.pathname;
                var search = window.location.search;
                
                // Log everything to help debug
                console.log('🔴 URL:', url);
                console.log('🔴 Pathname:', pathname);
                console.log('🔴 Search:', search);
                
                // Comprehensive check for verification indicators
                var isVerification = 
                    url.includes('verification=true') || 
                    url.includes('/verify') ||
                    pathname === '/verify' ||
                    pathname.startsWith('/verify') ||
                    search.includes('verification=');
                
                console.log('🔴 Is verification page:', isVerification);
                
                if (isVerification) {
                    console.log('🔴 VERIFICATION PAGE DETECTED IN PRODUCTION - FORCING DISPLAY');
                    
                    // Set ALL possible flags
                    window.__ON_VERIFICATION_PAGE__ = true;
                    window.__VERIFY_EMERGENCY_DETECTION__ = true;
                    window.__FORCE_VERIFICATION_PAGE__ = true;
                    window.__DISABLE_MOBILE_REDIRECT__ = true;
                    window.__FORCE_MOBILE_VIEW__ = false;
                    
                    // Clear all mobile-related storage
                    if (window.localStorage) {
                        window.localStorage.removeItem('isMobileDevice');
                    }
                    if (window.sessionStorage) {
                        window.sessionStorage.removeItem('isMobileDevice');
                    }
                    
                    // Override mobile detection functions
                    window.detectMobile = function() { return false; };
                    window.forceMobileRedirect = function() { return false; };
                    window.isVerificationPage = function() { return true; };
                    
                    // Add a special meta tag for verification
                    var meta = document.createElement('meta');
                    meta.name = 'x-verification-page';
                    meta.content = 'true';
                    document.head.appendChild(meta);
                    
                    // Create a style tag to force verification page visibility
                    var style = document.createElement('style');
                    style.textContent = `
                        .verification-page, [data-page="verify"] { display: block !important; }
                        .desktop-container { display: none !important; }
                        .mobile-container { display: none !important; }
                    `;
                    document.head.appendChild(style);
                    
                    // Set body class and attribute as soon as body exists
                    var bodyCheck = setInterval(function() {
                        if (document.body) {
                            document.body.classList.add('verification-page');
                            document.body.setAttribute('data-page', 'verify');
                            clearInterval(bodyCheck);
                            console.log('🔴 Added verification classes to body');
                        }
                    }, 10);
                    
                    // Force validation state to persist
                    setInterval(function() {
                        window.__ON_VERIFICATION_PAGE__ = true;
                        window.__VERIFY_EMERGENCY_DETECTION__ = true;
                        window.__FORCE_VERIFICATION_PAGE__ = true;
                    }, 100);
                }
            } catch (e) {
                console.error('Error in ultra aggressive verification check:', e);
            }
        })();
    </script>
    
    <!-- EMERGENCY VERIFICATION REDIRECT - This must be first! -->
    <script>
        (function() {
            // Detect verification path as early as possible
            try {
                var isVerifyPath = 
                    window.location.pathname === '/verify' ||
                    window.location.pathname.startsWith('/verify') ||
                    window.location.href.includes('/verify');
                
                if (isVerifyPath) {
                    console.log('🚨 EMERGENCY VERIFICATION PATH DETECTED');
                    
                    // Mark with global flag that will be checked later
                    window.__VERIFY_EMERGENCY_DETECTION__ = true;
                    
                    // Block all mobile redirects
                    window.__FORCE_MOBILE_VIEW__ = false;
                    window.__ON_VERIFICATION_PAGE__ = true;
                    
                    // Set parameter that will persist through redirects
                    var currentUrl = new URL(window.location.href);
                    if (!currentUrl.searchParams.has('verification')) {
                        currentUrl.searchParams.set('verification', 'true');
                        history.replaceState(null, '', currentUrl.toString());
                    }
                    
                    // Prepare to override any storage attempts
                    var originalLocalStorageSetItem = localStorage.setItem;
                    localStorage.setItem = function(key, value) {
                        if (key === 'isMobileDevice') {
                            console.log('🚫 Blocked mobile storage flag: localStorage.' + key);
                            return;
                        }
                        originalLocalStorageSetItem.call(localStorage, key, value);
                    };
                    
                    var originalSessionStorageSetItem = sessionStorage.setItem;
                    sessionStorage.setItem = function(key, value) {
                        if (key === 'isMobileDevice') {
                            console.log('🚫 Blocked mobile storage flag: sessionStorage.' + key);
                            return;
                        }
                        originalSessionStorageSetItem.call(sessionStorage, key, value);
                    };
                    
                    // Clear any existing mobile flags
                    localStorage.removeItem('isMobileDevice');
                    sessionStorage.removeItem('isMobileDevice');
                }
            } catch (e) {
                console.error('Error in emergency verification path detection:', e);
            }
        })();
    </script>
    
    <!-- Check for desktop mode immediately -->
    <script>
        // Early check for desktop mode parameter to prevent mobile flags
        (function() {
            try {
                // Check URL parameters for desktop mode indicators
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'desktop' || 
                    params.get('desktop') === 'true' || 
                    params.get('forceDesktop') === 'true') {
                    
                    console.log('Desktop mode detected - clearing all mobile flags early');
                    
                    // Clear all storage flags
                    localStorage.removeItem('isMobileDevice');
                    sessionStorage.removeItem('isMobileDevice');
                    
                    // Set global flag to prevent mobile detection
                    window.__FORCE_MOBILE_VIEW__ = false;
                    window.__DESKTOP_MODE_OVERRIDE__ = true;
                }
            } catch (e) {
                console.error('Error in early desktop mode detection:', e);
            }
        })();
    </script>
    
    <!-- VERIFY URL HACK: Check for /verify path and disable mobile redirects -->
    <script>
        (function() {
            // Check if URL contains /verify path
            if (window.location.pathname === '/verify' ||
                window.location.pathname.startsWith('/verify') ||
                window.location.href.includes('/verify')) {
                
                console.log('🔵 Verify path detected by early script - disabling mobile redirects');
                
                // Create global flags to prevent mobile detection/redirects
                window.__ON_VERIFICATION_PAGE__ = true;
                window.__DISABLE_MOBILE_REDIRECT__ = true;
                window.__FORCE_VERIFICATION_PAGE__ = true;
                
                // Override the isVerificationPage function
                window.isVerificationPage = function() { return true; };
                
                // Override storage methods temporarily
                var originalSetItem = Storage.prototype.setItem;
                Storage.prototype.setItem = function(key, value) {
                                        // Block setting mobile detection flags
                    if (key === 'isMobileDevice') {
                        console.log('🔵 Blocked setting mobile flag in storage');
                        return;
                    }
                    originalSetItem.call(this, key, value);
                };
                
                // Add class to body element as soon as it's available
                                document.addEventListener('DOMContentLoaded', function() {
                    document.body.classList.add('verification-page');
                    document.body.setAttribute('data-page', 'verify');
                    console.log('🔵 Added verification flags to body');
                });
                
                // Create observer to ensure verification flags stay on body
                var observer = new MutationObserver(function() {
                    if (!document.body.classList.contains('verification-page')) {
                        document.body.classList.add('verification-page');
                    }
                    if (document.body.getAttribute('data-page') !== 'verify') {
                        document.body.setAttribute('data-page', 'verify');
                    }
                });
                
                document.addEventListener('DOMContentLoaded', function() {
                    observer.observe(document.body, { attributes: true });
                });
            }
        })();
    </script>
    
    <!-- Define b_ immediately to prevent errors -->
    <script>
        // Create b_ with safety protections
        var b_ = {};
        Object.defineProperty(window, 'b_', {
            value: b_,
            writable: true,
            configurable: true,
            enumerable: true
        });
        
        // Also set on globalThis
        if (typeof globalThis !== 'undefined') {
            Object.defineProperty(globalThis, 'b_', {
                value: b_,
                writable: true,
                configurable: true,
                enumerable: true
            });
        }
        
        // Firefox detection
        var isFirefox = navigator.userAgent.indexOf('Firefox') > -1;
        if (isFirefox) {
            // Set flag for Firefox
            window.__IS_FIREFOX = true;
            
            // Add error interceptor for Firefox
            window.addEventListener('error', function(event) {
                if (event.message && (
                    event.message.includes('b_ is undefined') ||
                    event.message.includes('SES') ||
                    event.message.includes('lockdown')
                )) {
                    console.warn('Prevented Firefox error:', event.message);
                    // Restore b_ if needed
                    window.b_ = window.b_ || {};
                    if (typeof globalThis !== 'undefined') {
                        globalThis.b_ = globalThis.b_ || {};
                    }
                    event.preventDefault();
                    return true;
                }
            }, true);
        }
    </script>
    <!-- Load SES lockdown fix first -->
    <script src="/lockdown-fix.js"></script>
    <!-- Load compatibility script as early as possible -->
    <script src="/compatibility.js"></script>
    <!-- Add vendor.js polyfill specifically -->
    <script>
        // This handles the vendor.js b_ issue specifically
        document.addEventListener('DOMContentLoaded', function() {
            // Find any vendor.js scripts
            var scripts = document.querySelectorAll('script[src*="vendor"]');
            scripts.forEach(function(script) {
                console.log('Found vendor.js script:', script.src);
                // Ensure b_ exists before and after script loads
                window.b_ = window.b_ || {};
                if (typeof globalThis !== 'undefined') {
                    globalThis.b_ = globalThis.b_ || {};
                }
            });
            
            // Create observer for dynamically added vendor scripts
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length) {
                        for (var i = 0; i < mutation.addedNodes.length; i++) {
                            var node = mutation.addedNodes[i];
                            if (node.tagName === 'SCRIPT' && node.src && node.src.includes('vendor')) {
                                console.log('Vendor script dynamically added:', node.src);
                                // Set b_ again
                                window.b_ = window.b_ || {};
                                if (typeof globalThis !== 'undefined') {
                                    globalThis.b_ = globalThis.b_ || {};
                                }
                            }
                        }
                    }
                });
            });
            
            // Start observing
            observer.observe(document, { childList: true, subtree: true });
        });
    </script>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>JumpNads</title>
    
    <!-- Farcaster Frame Metadata -->
    <meta property="fc:frame" content='{"version":"next","imageUrl":"https://doodle-jump.vercel.app/farcaster/frame-thumbnail.png","button":{"title":"Play JumpNads","action":{"type":"launch_frame","name":"JumpNads - Doodle Jump","url":"https://doodle-jump.vercel.app","splashImageUrl":"https://doodle-jump.vercel.app/farcaster/splash-icon.png","splashBackgroundColor":"#f7f7f7"}}}' />
    
    <!-- Farcaster Frame SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk/dist/index.min.js"></script>
    
    <!-- CRITICAL: Add this script to catch verification=true parameter BEFORE React loads -->
    <script>
        (function() {
            // Emergency verification detection
            var url = window.location.href;
            if (url.includes('verification=true') || url.includes('/verify')) {
                console.log('⚠️ PRE-LOAD Verification detected:', url);
                // Set flags that React will check
                window.__ON_VERIFICATION_PAGE__ = true;
                window.__VERIFY_EMERGENCY_DETECTION__ = true;
                // Remove any mobile flags that might interfere
                localStorage.removeItem('isMobileDevice');
                sessionStorage.removeItem('isMobileDevice');
                window.__FORCE_MOBILE_VIEW__ = false;
                // Add a class to body for CSS to pick up
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.classList.add('verification-page');
                    document.body.setAttribute('data-page', 'verify');
                });
            }
        })();
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    
    <!-- Call ready function -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.frame && window.frame.sdk && window.frame.sdk.actions) {
                window.frame.sdk.actions.ready();
            }
        });
    </script>
</body>
</html>