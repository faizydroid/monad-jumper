<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Doodle Jump</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Fredoka:wght@400;600&family=Short+Stack&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #canvas1 {
            border: 5px solid black;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            display: none; /* Hide canvas initially */
        }

        #bg, #monad0, #virus, #green_platform, #blue_platform, #brown_platform, #white_platform, #bullet {
            display: none;
        }

        /* Game juice animations */
        @keyframes squash {
            0% { transform: scaleY(1) scaleX(1); }
            50% { transform: scaleY(0.7) scaleX(1.3); }
            100% { transform: scaleY(1) scaleX(1); }
        }
        
        @keyframes stretch {
            0% { transform: scaleY(1) scaleX(1); }
            50% { transform: scaleY(1.3) scaleX(0.7); }
            100% { transform: scaleY(1) scaleX(1); }
        }
        
        @keyframes platformJiggle {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-2deg) scale(1.05); }
            50% { transform: rotate(0deg) scale(1.1); }
            75% { transform: rotate(2deg) scale(1.05); }
            100% { transform: rotate(0deg) scale(1); }
        }
        
        @keyframes platformGlow {
            0% { filter: brightness(1) drop-shadow(0 0 0px rgba(255, 255, 255, 0)); }
            50% { filter: brightness(1.5) drop-shadow(0 0 10px rgba(255, 255, 255, 0.7)); }
            100% { filter: brightness(1) drop-shadow(0 0 0px rgba(255, 255, 255, 0)); }
        }
        
        @keyframes scorePopup {
            0% { transform: scale(0.5); opacity: 0; }
            10% { transform: scale(1.2); opacity: 1; }
            20% { transform: scale(1); opacity: 1; }
            80% { transform: scale(1) translateY(-20px); opacity: 1; }
            100% { transform: scale(1) translateY(-30px); opacity: 0; }
        }
        
        @keyframes comboPopup {
            0% { transform: scale(0.5); opacity: 0; }
            10% { transform: scale(1.5); opacity: 1; }
            30% { transform: scale(1.2); opacity: 1; }
            90% { transform: scale(1.2) translateY(-30px); opacity: 1; }
            100% { transform: scale(1) translateY(-40px); opacity: 0; }
        }
        
        /* Add bullet screen glow animation */
        @keyframes screenGlow {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); }
            25% { box-shadow: 0 0 50px 20px rgba(255, 255, 0, 0.5); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); }
        }
        
        .score-popup {
            position: absolute;
            font-family: 'Bangers', cursive;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 100;
            animation: scorePopup 1s forwards;
        }
        
        .combo-popup {
            position: absolute;
            font-family: 'Bangers', cursive;
            color: #FFD700;
            font-size: 32px;
            text-shadow: 
                2px 2px 0 #000,
                0 0 10px rgba(255, 215, 0, 0.7);
            pointer-events: none;
            z-index: 100;
            animation: comboPopup 1.5s forwards;
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 99;
        }
        
        .particle.flame {
            width: 10px;
            height: 10px;
            background: linear-gradient(to top, #FF5722, #FFC107);
            border-radius: 50%;
            opacity: 0.8;
        }
        
        .particle.star {
            width: 8px;
            height: 8px;
            background-color: white;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        
        .particle.trail {
            width: 6px;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            opacity: 0.6;
        }
        
        /* Wing style for glide powerup */
        .wings {
            position: absolute;
            width: 40px;
            height: 30px;
            background-image: url('images/wing.png');
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 98;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
        }
        
        .wings.left {
            transform: scaleX(-1);
        }

        /* Game title and UI styles */
        .game-title {
            font-family: 'Bangers', cursive;
            font-size: clamp(3.5rem, 10vw, 7rem);
            color: white;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 0.25rem;
            letter-spacing: 3px;
            padding-top: 100px;
            text-shadow: 
                5px 5px 0 #9B5DE5,
                10px 10px 0 rgba(0,0,0,0.2);
            transform: rotate(-2deg);
        }

        .character-container {
            position: relative;
            width: 170px;
            height: 60px;
            margin: 2rem auto;
        }

        .character {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 120px;
            background-image: url('images/monad0.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: character-bounce 2s ease-in-out infinite;
            z-index: 1;
        }

        .shadow {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 14px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 50%;
            filter: blur(3px);
            animation: shadow-pulse 2s ease-in-out infinite;
        }

        #playButton {
            display: block;
            margin: 20px auto 40px;
            background: linear-gradient(90deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
            font-family: 'Fredoka', cursive;
            font-size: 24px;
            font-weight: bold;
            padding: 18px 42px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 0 rgba(220, 50, 50, 0.5), 0 14px 24px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
            overflow: hidden;
            min-width: 240px;
            transform-origin: center bottom;
        }

        #playButton:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 0 rgba(220, 50, 50, 0.5), 0 18px 28px rgba(0, 0, 0, 0.25);
        }

        #playButton:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 6px 0 rgba(220, 50, 50, 0.5), 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        @keyframes character-bounce {
            0%, 100% { transform: translateY(0) translateX(-50%); }
            50% { transform: translateY(-30px) translateX(-50%); }
        }

        @keyframes shadow-pulse {
            0%, 100% { width: 70px; opacity: 0.25; }
            50% { width: 45px; opacity: 0.1; }
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            overflow: hidden;
            background-image: url('images/iframebg.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        #gameCanvas {
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #startScreen {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background-image: url('images/iframebg.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }

        .connect-wallet-message {
            background: rgba(0, 0, 0, 0.7);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
            max-width: 300px;
        }
        
        .connect-wallet-message p {
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        #connectButton {
            background: linear-gradient(90deg, #5662EB 0%, #7C3AED 100%);
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 16px;
            font-weight: bold;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 rgba(92, 71, 255, 0.5), 0 10px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        #connectButton:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 0 rgba(92, 71, 255, 0.5), 0 14px 20px rgba(0, 0, 0, 0.25);
        }
        
        #connectButton:active {
            transform: translateY(2px);
            box-shadow: 0 4px 0 rgba(92, 71, 255, 0.5), 0 8px 10px rgba(0, 0, 0, 0.2);
        }

        .game-title {
            margin-bottom: 1.5rem;
        }

        .character-container {
            margin-bottom: 2.5rem; /* Add more space below character */
        }

        #playButton {
            margin-top: 30px;
            background: linear-gradient(90deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
            font-family: 'Fredoka', cursive;
            font-size: 28px;
            font-weight: bold;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 0 rgba(220, 50, 50, 0.5), 0 12px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
            overflow: hidden;
            min-width: 200px;
            transform-origin: center bottom;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        #playButton:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 0 rgba(220, 50, 50, 0.5), 0 18px 28px rgba(0, 0, 0, 0.25);
            animation-play-state: paused;
        }

        #playButton:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 6px 0 rgba(220, 50, 50, 0.5), 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        /* Add cartoon clouds */
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            filter: blur(3px);
            opacity: 0.8;
            animation: float 15s infinite linear;
        }

        .cloud-1 {
            width: 100px;
            height: 60px;
            top: 15%;
            left: 10%;
            animation-duration: 35s;
        }

        .cloud-2 {
            width: 150px;
            height: 80px;
            top: 25%;
            right: 15%;
            animation-duration: 45s;
        }

        .cloud-3 {
            width: 120px;
            height: 65px;
            bottom: 20%;
            left: 20%;
            animation-duration: 40s;
        }

        /* Add bouncing platforms */
        .floating-platform {
            position: absolute;
            width: 100px;
            height: 30px;
            background-image: url('images/green_platform.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: float-updown 3s infinite ease-in-out;
        }

        .platform-1 {
            top: 30%;
            left: 15%;
            animation-delay: 0.5s;
        }

        .platform-2 {
            bottom: 25%;
            right: 20%;
            animation-delay: 1s;
        }

        .platform-3 {
            top: 5%;
            left: 65%;
            animation-delay: 1.5s;
        }
        .platform-4 {
            top: 35%;
            left: 85%;
            animation-delay: 1.5s;
        }
        .platform-5 {
            top: 15%;
            left: 45%;
            animation-delay: 1.5s;
        }
        .platform-6 {
            top: 95%;
            left: 65%;
            animation-delay: 1.5s;
        }

        .platform-7 {
            top: 55%;
            left: 5%;
            animation-delay: 1.5s;
        }
        .platform-8 {
            top: 85%;
            left: 15%;
            animation-delay: 1.5s;
        }
        /* Add cartoon stars */
        .star {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #FFDE59;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: twinkle 3s infinite ease-in-out;
        }

        .star-1 {
            top: 15%;
            right: 25%;
            animation-delay: 0s;
        }

        .star-2 {
            bottom: 30%;
            left: 10%;
            animation-delay: 0.7s;
        }

        .star-3 {
            top: 45%;
            right: 15%;
            animation-delay: 1.4s;
        }

        .star-4 {
            bottom: 15%;
            right: 35%;
            animation-delay: 2.1s;
        }

        /* Title decoration */
        .title-container {
            position: relative;
            margin-bottom: 2rem;
        }

       

        /* Improve Play button with pulsing effect */
        #playButton {
            margin-top: 30px;
            background: linear-gradient(90deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
            font-family: 'Fredoka', cursive;
            font-size: 32px;
            font-weight: bold;
            padding: 20px 60px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 
                0 8px 0 rgba(220, 50, 50, 0.8), 
                0 12px 20px rgba(0, 0, 0, 0.3),
                0 0 0 6px rgba(255, 255, 255, 0.4);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            min-width: 220px;
            transform-origin: center bottom;
            animation: pulse 2s infinite ease-in-out;
        }

        #playButton:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255,255,255,0.2);
            transform: rotate(30deg);
            transition: all 0.3s;
        }

        #playButton:hover {
            transform: translateY(-6px) scale(1.05);
            box-shadow: 
                0 14px 0 rgba(220, 50, 50, 0.8), 
                0 20px 30px rgba(0, 0, 0, 0.3),
                0 0 0 6px rgba(255, 255, 255, 0.6);
            animation-play-state: paused;
        }

        #playButton:hover:after {
            left: 120%;
        }

        #playButton:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 
                0 4px 0 rgba(220, 50, 50, 0.8), 
                0 8px 10px rgba(0, 0, 0, 0.2),
                0 0 0 6px rgba(255, 255, 255, 0.4);
        }

        /* Game version text */
        .game-version {
            position: absolute;
            bottom: 10px;
            right: 10px;
            color: white;
            font-family: 'Fredoka', cursive;
            font-size: 12px;
            opacity: 0.7;
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }

        @keyframes float-updown {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 8px 0 rgba(220, 50, 50, 0.8), 0 12px 20px rgba(0, 0, 0, 0.3), 0 0 0 6px rgba(255, 255, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 10px 0 rgba(220, 50, 50, 0.8), 0 16px 25px rgba(0, 0, 0, 0.3), 0 0 0 10px rgba(255, 255, 255, 0.2); }
        }

        /* Cross-browser centering fix */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        #canvas1 {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            z-index: 5;
        }

        #startScreen {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* Game container (add this if you have a container div) */
        .game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Controls display styling - more minimal and beautiful */
        .controls-container {
            background-color: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 16px 20px;
            max-width: 320px;
            margin: 0 auto 25px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .controls-title {
            color: white;
            font-size: 18px;
            margin: 0 0 12px;
            letter-spacing: 1px;
            font-weight: 600;
            text-align: center;
            opacity: 0.9;
        }
        
        .controls-instructions {
            display: flex;
            justify-content: center;
            gap: 24px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .control-icon {
            font-size: 20px;
            height: 40px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .control-text {
            font-size: 14px;
            text-align: center;
            opacity: 0.8;
            font-weight: 400;
        }
        
        /* Control icon hover effect */
        .control-item:hover .control-icon {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Adjust for mobile */
        @media (max-width: 480px) {
            .controls-container {
                padding: 12px 16px;
                max-width: 280px;
            }
            
            .controls-title {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            .control-icon {
                font-size: 18px;
                height: 36px;
                width: 36px;
            }
            
            .control-text {
                font-size: 12px;
            }
        }

        /* Adjust spacing for controls after play button */
        #playButton {
            margin-bottom: 10px;
        }
        
        #controls-instructions {
            margin-top: 20px;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <canvas id="canvas1"></canvas>
    <img src='/images/background.png' id='bg' /> 
    <img src='/images/monad0.png' id='monad0' /> 
    <img src='/images/virus.png' id='virus' /> 
    <img src='/images/bullet.png' id='bullet' /> 
    <img src='/images/green_platform.png' id='green_platform' />
    <img src='/images/blue_platform.png' id='blue_platform' />
    <img src='/images/brown_platform.png' id='brown_platform' />
    <img src='/images/white_platform.png' id='white_platform' />
    
    <!-- Game juice effects container -->
    <div id="juice-effects-container"></div>
    
    <!-- Audio elements for sound effects -->
    <audio id="sound-jump" src="/sounds/jump.mp3" preload="auto"></audio>
    <audio id="sound-land" src="/sounds/land.mp3" preload="auto"></audio>
    <audio id="sound-boost" src="/sounds/boost.mp3" preload="auto"></audio>
    <audio id="sound-combo" src="/sounds/combo.mp3" preload="auto"></audio>
    <audio id="sound-hit" src="/sounds/hit.mp3" preload="auto"></audio>
    <audio id="sound-dramatic" src="/sounds/dramatic.mp3" preload="auto"></audio>
    <audio id="sound-spring" src="/sounds/spring.mp3" preload="auto"></audio>
    <audio id="sound-fall" src="sound effects/fall.mp3" preload="auto"></audio>
    <!-- Add background music audio element -->
    <audio id="bg-music" src="/sound effects/bgmusic.mp3" loop preload="auto"></audio>
    
    <div id="startScreen">
        <!-- Add decorative elements -->
      
        
        <div class="floating-platform platform-1"></div>
        <div class="floating-platform platform-2"></div>
        <div class="floating-platform platform-3"></div>
        <div class="floating-platform platform-4"></div>
        <div class="floating-platform platform-5"></div>
        <div class="floating-platform platform-6"></div>
        <div class="floating-platform platform-7"></div>
        <div class="floating-platform platform-8"></div>
    
        <!-- Styled title -->
        <div class="title-container">
            <div class="title-bg"></div>
            <h1 class="game-title">JumpNads</h1>
        </div>
        
        <!-- Character animation -->
        <div class="character-container">
            <div class="shadow"></div>
            <div class="character"></div>
        </div>
        
        <!-- Play button will be added dynamically by the game code -->
        
        <!-- Version indicator -->
        <div class="game-version">v1.0</div>

        <!-- Find the tagline element and make sure it has proper styling -->
     
    </div>
    
    <script>
        // Auto-focus handler
        window.addEventListener('message', function(event) {
            if (event.data === 'focus') {
                document.getElementById('canvas1').focus();
            }
        });

        // Also focus on load
        window.addEventListener('load', function() {
            document.getElementById('canvas1').focus();
        });

        // Add this near the top of your game file to receive messages from the React app
        let playerAddress = null;
        let hasWallet = false;

        window.addEventListener('message', (event) => {
            // Make sure we trust the sender of this message
            if (event.origin !== window.location.origin) return;
            
            const { type, data } = event.data;
            
            switch (type) {
                case 'GAME_INIT':
                    playerAddress = data.playerAddress;
                    hasWallet = data.hasWallet;
                    console.log('Game initialized with address:', playerAddress);
                    break;
                    
                case 'POWER_UP_RESPONSE':
                    // Handle power-up purchase response
                    handlePowerUpResponse(data);
                    break;
                    
                case 'CONTINUE_RESPONSE':
                    // Handle continue purchase response
                    handleContinueResponse(data);
                    break;
                
                // Add music control message handling
                case 'MUSIC_VOLUME':
                    const bgMusic = document.getElementById('bg-music');
                    if (bgMusic) {
                        bgMusic.volume = event.data.volume;
                        console.log('Set background music volume:', event.data.volume);
                        
                        // Also save to localStorage for persistence
                        localStorage.setItem('bgMusicVolume', event.data.volume);
                    }
                    break;
                
                case 'MUSIC_PLAY_STATE':
                    const bgMusicElement = document.getElementById('bg-music');
                    if (bgMusicElement) {
                        if (event.data.isPlaying) {
                            bgMusicElement.play().catch(err => {
                                console.error("Failed to play background music:", err);
                            });
                            console.log('Playing background music');
                        } else {
                            bgMusicElement.pause();
                            console.log('Paused background music');
                        }
                    }
                    break;
                    
                // Handle audio mute state
                case 'AUDIO_MUTE_STATE':
                    if (typeof event.data.muted === 'boolean' && window.setAudioMuted) {
                        window.setAudioMuted(false); // Always force unmuted
                        console.log('Force unmuted audio despite parent request');
                    }
                    break;
                    
                // Handle audio toggle request
                case 'AUDIO_TOGGLE':
                    if (window.toggleAudio) {
                        window.toggleAudio(); // Will always set to unmuted now
                        console.log('Audio toggled by parent (forced to unmuted)');
                    }
                    break;
                    
                // Handle audio context resume request
                case 'AUDIO_RESUME':
                    if (window.audioManager && window.audioManager.audioContext) {
                        if (window.audioManager.audioContext.state === 'suspended') {
                            window.audioManager.audioContext.resume().then(() => {
                                console.log('AudioContext resumed by parent request');
                            });
                        }
                    }
                    break;
                    
                // New message types
                case 'PLAY_BACKGROUND_MUSIC':
                    // Play background music directly
                    const bgMusicToPlay = document.getElementById('bg-music');
                    if (bgMusicToPlay) {
                        const volume = event.data.volume || 0.5;
                        bgMusicToPlay.volume = volume;
                        bgMusicToPlay.muted = false;
                        bgMusicToPlay.currentTime = 0;
                        bgMusicToPlay.play().catch(err => {
                            console.error("Failed to play background music:", err);
                        });
                        console.log('Playing background music from explicit request');
                    }
                    break;
                
                case 'FORCE_AUDIO_UNMUTE':
                    // Force parent UI to unmute audio
                    try {
                        window.parent.postMessage({
                            type: 'UPDATE_AUDIO_UI',
                            muted: false,
                            volume: 0.5
                        }, '*');
                        
                        // Also force all audio to be unmuted
                        document.querySelectorAll('audio').forEach(audio => {
                            audio.muted = false;
                        });
                        
                        if (window.audioManager) {
                            window.audioManager.setMuted(false);
                        }
                        
                        console.log('Forced audio unmute complete');
                    } catch (e) {
                        console.warn('Error in force unmute:', e);
                    }
                    break;
            }
        });

        // Function to send score increments to the blockchain
        function sendScoreIncrement(points) {
            if (!hasWallet) return;
            
            window.parent.postMessage({
                type: 'SCORE_INCREMENT',
                data: { points }
            }, '*');
        }

        // Function to request a power-up
        function requestPowerUp(powerUpType) {
            if (!hasWallet) return false;
            
            window.parent.postMessage({
                type: 'POWER_UP_REQUEST',
                data: { powerUpType }
            }, '*');
            
            // Return will happen asynchronously via message event
            return true;
        }

        // Function to request a continue after game over
        function requestContinue() {
            if (!hasWallet) return false;
            
            window.parent.postMessage({
                type: 'CONTINUE_REQUEST',
                data: {}
            }, '*');
            
            // Return will happen asynchronously via message event
            return true;
        }

        // Add these functions to your game logic:
        function handlePowerUpResponse(data) {
            if (data.success) {
                // Apply the power-up in the game
                console.log(`Power-up ${data.powerUpType} activated!`);
                // Your game-specific power-up logic here
            } else {
                // Show error message to player
                console.log(`Failed to purchase power-up: ${data.powerUpType}`);
            }
        }

        function handleContinueResponse(data) {
            if (data.success) {
                // Continue the game
                console.log('Game continued!');
                // Your game-specific continue logic here
            } else {
                // Show error message
                console.log('Failed to purchase continue');
            }
        }

        // Call these functions in your game:
        // Example: When player collects 10 points
        function exampleCollectPoints() {
            // Update local game score
            gameScore += 10;
            
            // Send transaction for each 10 points (generates lots of transactions)
            sendScoreIncrement(10);
        }

        // Example: When player dies
        function examplePlayerDies() {
            // Show continue option
            const wantsToContinue = confirm('Continue for 0.0002 MON?');
            
            if (wantsToContinue) {
                requestContinue();
                // The actual continue will happen when the response comes back
            } else {
                gameOver(gameScore);
            }
        }

        // Example: Power-up purchase
        function exampleBuyPowerUp() {
            const powerUpType = 'SUPER_JUMP'; // Or any power-up type your game supports
            requestPowerUp(powerUpType);
            // The actual power-up will be applied when the response comes back
        }

        // Expose juice effects hooks for the main game
        window.applyJumpEffect = function(playerElement) {
            if (window.juiceEffects) {
                window.juiceEffects.applyStretch(playerElement);
            }
        };
        
        window.applyLandEffect = function(playerElement, platformElement) {
            if (window.juiceEffects) {
                window.juiceEffects.applySquash(playerElement);
                window.juiceEffects.platformEffect(platformElement, Math.random() > 0.5 ? 'jiggle' : 'glow');
            }
        };
        
        window.applyScoreEffect = function(x, y, points, isCombo) {
            if (window.juiceEffects) {
                window.juiceEffects.showScorePopup(x, y, points, isCombo);
                window.juiceEffects.createParticles(x, y, 'star', isCombo ? 15 : 5);
            }
        };
        
        // Hook into existing game code
        const originalJump = window.jump || function(){};
        window.jump = function(player) {
            // Call original jump function
            const result = originalJump.apply(this, arguments);
            
            // Apply juice effects
            if (player && player.element) {
                window.applyJumpEffect(player.element);
            }
            
            return result;
        };

        // Single source of truth for jump counting
        window.__jumpCount = 0;

        // Intercept jump transactions with a simpler implementation
        const originalSetTimeout = window.setTimeout;
        window.setTimeout = function(callback, delay) {
            if (callback?.toString().includes('jump transaction')) {
                return originalSetTimeout(() => {
                    // Increment jump count
                    window.__jumpCount++;
                    console.log('ðŸŽ® Jump counted:', window.__jumpCount);
                    return true;
                }, 10);
            }
            return originalSetTimeout(callback, delay);
        };

        // Clean game over function
        function gameOver(finalScore) {
            console.log('ðŸŽ® Game Over triggered');
            console.log('Final Score:', finalScore);
            console.log('Total Jumps:', window.__jumpCount);

            // Send final data to parent
            window.parent.postMessage({
                type: 'GAME_OVER',
                data: {
                    finalScore: finalScore,
                    jumpCount: window.__jumpCount,
                    timestamp: Date.now()
                }
            }, '*');
        }

        // Clean reset function
        window.addEventListener('message', function(event) {
            if (event.data?.type === 'RESET_GAME') {
                console.log('ðŸŽ® Resetting game and jump counter');
                window.__jumpCount = 0;
                console.log('Jump counter reset to:', window.__jumpCount);
            }
        });

        // Debug logging
        setInterval(() => {
            console.log('Current jump count:', window.__jumpCount);
        }, 5000);
    </script>
    
    <script type="module" src="/js/background.js"></script>
    <script type="module" src="/js/bullet.js"></script>
    <script type="module" src="/js/enemy.js"></script>
    <script type="module" src="/js/input.js"></script>
    <script type="module" src="/js/platform.js"></script>
    <script type="module" src="/js/player.js"></script>
    <script type="module" src="/js/main.js"></script>

    <!-- Add this right after the main.js import to hook into the game instance -->
    <script>
      // Wait for the game instance to be created
      function connectJuiceToGame() {
        if (!window.gameInstance) {
          setTimeout(connectJuiceToGame, 100);
          return;
        }
        
        console.log("ðŸŽ® Connecting juice effects to game instance");
        
        // Hook into player jumps
        const originalPlayerUpdate = window.gameInstance.player.update;
        window.gameInstance.player.update = function() {
          const prevSpeedY = this.speedY;
          const result = originalPlayerUpdate.apply(this, arguments);
          
          // Detect jump (when speedY changes from 0/positive to negative)
          if (prevSpeedY >= 0 && this.speedY < 0) {
            // Player jumped - apply stretch effect
            window.juiceEffects.applyStretch(document.getElementById('canvas1'));
            
            // Create particles below player
            const x = this.x + this.width/2;
            const y = this.y + this.height;
            window.juiceEffects.createParticles(x, y, 'star', 8, 800);
          }
          
          // Detect landing (when speedY changes from negative to 0/positive)
          if (prevSpeedY < 0 && this.speedY >= 0) {
            // Player landed - apply squash effect
            window.juiceEffects.applySquash(document.getElementById('canvas1'));
            
            // Screen shake on big landings (if falling fast)
            if (prevSpeedY < -10) {
              window.juiceEffects.screenShake(Math.min(Math.abs(prevSpeedY) * 0.5, 15), 300);
            }
          }
          
          return result;
        };
        
        // Hook into player's onPlatform method to detect brown platforms
        const originalOnPlatform = window.gameInstance.player.onPlatform;
        window.gameInstance.player.onPlatform = function() {
          const platformType = originalOnPlatform.apply(this, arguments);
          return platformType;
        };
        
        // Hook into player's shootTop method to remove the squeezing effect
        if (window.gameInstance.player.shootTop) {
          console.log("Removing squeezing effect from bullet shooting");
          const originalShootTop = window.gameInstance.player.shootTop;
          window.gameInstance.player.shootTop = function() {
            // Add screen glow effect when bullet is shot
            console.log("Applying bullet screen glow effect");
            if (window.juiceEffects && window.juiceEffects.canvas) {
              window.juiceEffects.canvas.style.animation = 'screenGlow 0.5s ease-out';
              setTimeout(() => {
                if (window.juiceEffects.canvas) {
                  window.juiceEffects.canvas.style.animation = '';
                }
              }, 500);
            }
            
            // Call original method
            return originalShootTop.apply(this, arguments);
          };
        }
        
        // Also hook into processJump as an alternative detection method
        if (window.gameInstance.player.processJump) {
          const originalProcessJump = window.gameInstance.player.processJump;
          window.gameInstance.player.processJump = function(platformType) {
            // Call original first
            const result = originalProcessJump.apply(this, arguments);
            
            // Now check for brown platforms
            if (platformType === 'brown') {
              console.log("ðŸŽ® BROWN PLATFORM JUMP PROCESSED!");
              
              // Create particle explosion
              const x = this.x + this.width/2;
              const y = this.y + this.height;
              window.juiceEffects.createParticles(x, y, 'star', 15, 1000);
              
              // Show crash text
              window.juiceEffects.showScorePopup(x, y - 30, "CRASH!", true);
              
              // Apply very strong screen shake
              window.juiceEffects.screenShake(25, 700);
            }
            // Handle spring platforms
            else if (platformType === 'spring') {
              console.log("ðŸŽ® SPRING PLATFORM JUMP PROCESSED!");
              
              // Create special spring particles
              const x = this.x + this.width/2;
              const y = this.y + this.height;
              
              // Create spiral particle effect for spring
              for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                  window.juiceEffects.createParticles(
                    x, 
                    y - (i * 3), 
                    'star', 
                    2, 
                    1500
                  );
                }, i * 30);
              }
              
              // Show boost text
              window.juiceEffects.showScorePopup(x, y - 80, "BOOST!", true);
              
              // Play spring sound if available
              const springSound = document.getElementById('sound-spring');
              if (springSound) {
                springSound.currentTime = 0;
                springSound.play().catch(e => console.log("Error playing spring sound:", e));
              }
              
              // Apply medium screen shake but longer lasting
              window.juiceEffects.screenShake(15, 1000);
            }
            
            return result;
          };
        }
        
        // Hook into score changes
        const originalAddScore = window.gameInstance.addScore || function() {};
        window.gameInstance.addScore = function(points) {
          const result = originalAddScore.apply(this, arguments);
          
          // Show score popup
          const playerX = this.player.x + this.player.width/2;
          const playerY = this.player.y;
          
          // Keep track of combos
          if (!this._comboData) {
            this._comboData = {
              count: 0,
              lastTime: 0,
              timeout: null
            };
          }
          
          const now = Date.now();
          const timeDiff = now - this._comboData.lastTime;
          
          if (timeDiff < 2000) {
            // Combo continues
            this._comboData.count++;
            clearTimeout(this._comboData.timeout);
          } else {
            // New combo
            this._comboData.count = 1;
          }
          
          this._comboData.lastTime = now;
          
          // Show combo or regular score
          if (this._comboData.count >= 3) {
            // It's a combo!
            const comboPoints = points * this._comboData.count;
            window.juiceEffects.showScorePopup(playerX, playerY, comboPoints, true);
            
            // Create celebratory particles
            window.juiceEffects.createParticles(playerX, playerY, 'star', 15, 1200);
            
            // Screen shake for big combos
            if (this._comboData.count >= 5) {
              window.juiceEffects.screenShake(8, 400);
            }
            
            // Play dramatic sound on big combos
            if (this._comboData.count >= 8) {
              window.juiceEffects.dramaticMoment(800);
            }
          } else {
            // Regular score
            window.juiceEffects.showScorePopup(playerX, playerY, points, false);
          }
          
          // Reset combo after a delay
          this._comboData.timeout = setTimeout(() => {
            this._comboData.count = 0;
          }, 2000);
          
          return result;
        };
        
        console.log("ðŸŽ® Juice effects connected successfully");
      }
      
      // Start connecting once the page has loaded
      window.addEventListener('load', connectJuiceToGame);
    </script>

    <!-- Direct game over detection script - STRICT VERSION -->
    <script>
      // ... existing code ...
    </script>

    <!-- Direct access to check jump counter -->
    <script>
      // ... existing code ...
    </script>

    <!-- Check if platform images are loaded correctly -->
    <script>
      // ... existing code ...
    </script>

    <!-- Detect if device is mobile -->
    <script>
      // ... existing code ...
    </script>

    <!-- Move the controls-instructions div -->
    <script>
      // ... existing code ...
    </script>

    <!-- Game juice JavaScript functions -->
    <script>
        console.log("ðŸŽ® Game juice effects script loaded");
        
        // Add visible debug section to the page
        const debugElement = document.createElement('div');
        debugElement.style.position = 'fixed';
        debugElement.style.bottom = '10px';
        debugElement.style.right = '10px';
        debugElement.style.background = 'rgba(0,0,0,0.7)';
        debugElement.style.color = 'white';
        debugElement.style.padding = '5px 10px';
        debugElement.style.fontSize = '12px';
        debugElement.style.zIndex = '9999';
        debugElement.style.fontFamily = 'monospace';
        document.body.appendChild(debugElement);
        
        // Direct effect that always shows (regardless of game integration)
        function createOverlayEffects() {
            // Create fancy stars in background
            function createStar() {
                const star = document.createElement('div');
                star.style.position = 'fixed';
                star.style.width = Math.random() * 15 + 5 + 'px';
                star.style.height = star.style.width;
                star.style.backgroundColor = `hsl(${Math.random() * 60}, 100%, 75%)`;
                star.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.zIndex = '9000';
                star.style.filter = 'drop-shadow(0 0 5px rgba(255,255,255,0.7))';
                star.style.opacity = '0';
                star.style.transition = 'opacity 0.5s ease, transform 5s ease';
                
                document.body.appendChild(star);
                
                // Animate
                setTimeout(() => {
                    star.style.opacity = '0.7';
                    star.style.transform = 'rotate(360deg) translateY(-50vh)';
                }, 10);
                
                // Remove after animation
                setTimeout(() => {
                    star.style.opacity = '0';
                    setTimeout(() => star.remove(), 1000);
                }, 4500);
            }
            
            // Create stars periodically
            setInterval(createStar, 2000);
            
            // Add animation keyframes
            const styleEl = document.createElement('style');
            styleEl.textContent = `
                @keyframes screen-shake {
                    0%, 100% { transform: translate(0, 0); }
                    10% { transform: translate(-5px, 5px); }
                    20% { transform: translate(5px, -5px); }
                    30% { transform: translate(-6px, -6px); }
                    40% { transform: translate(6px, 6px); }
                    50% { transform: translate(-4px, -4px); }
                    60% { transform: translate(4px, 4px); }
                    70% { transform: translate(-6px, -2px); }
                    80% { transform: translate(2px, -6px); }
                    90% { transform: translate(-5px, 5px); }
                }
                
                @keyframes score-pop {
                    0% { transform: scale(0.5); opacity: 0; }
                    10% { transform: scale(1.5); opacity: 1; }
                    20% { transform: scale(1.2); opacity: 1; }
                    80% { transform: translateY(-50px) scale(1.2); opacity: 1; }
                    100% { transform: translateY(-100px) scale(1); opacity: 0; }
                }
                
                .score-popup {
                    position: fixed;
                    font-family: 'Bangers', cursive;
                    color: white;
                    font-size: 36px;
                    text-shadow: 3px 3px 0 #000, 0 0 10px gold;
                    pointer-events: none;
                    z-index: 9999;
                    animation: score-pop 1.5s forwards;
                }
            `;
            document.head.appendChild(styleEl);
            
            // Create particle effect
            function createParticleEffect(x, y, count = 5) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'fixed';
                    particle.style.width = (Math.random() * 12 + 5) + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.backgroundColor = 'white';
                    particle.style.borderRadius = '50%';
                    particle.style.filter = 'drop-shadow(0 0 5px gold)';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    particle.style.zIndex = '9400';
                    document.body.appendChild(particle);
                    
                    // Animate
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 5 + 3;
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed - 5; // upward bias
                    
                    let opacity = 1;
                    let posX = x;
                    let posY = y;
                    
                    const interval = setInterval(() => {
                        opacity -= 0.05;
                        posX += vx;
                        posY += vy;
                        vy += 0.2; // gravity
                        
                        particle.style.opacity = opacity;
                        particle.style.left = posX + 'px';
                        particle.style.top = posY + 'px';
                        
                        if (opacity <= 0) {
                            clearInterval(interval);
                            particle.remove();
                        }
                    }, 30);
                }
            }
            
            // Create score popup
            function createScorePopup(x, y, text) {
                const popup = document.createElement('div');
                popup.className = 'score-popup';
                popup.textContent = text;
                popup.style.left = x + 'px';
                popup.style.top = y + 'px';
                document.body.appendChild(popup);
                
                // Remove after animation completes
                setTimeout(() => {
                    popup.remove();
                }, 1500);
            }
            
            
        }
        
        // Start overlay effects
        createOverlayEffects();
        
        // Original juice effects (keep this as backup)
        class JuiceEffects {
            constructor() {
                this.container = document.getElementById('juice-effects-container') || document.body;
                this.canvas = document.getElementById('canvas1');
                this.hasAudio = false; // Audio disabled by default
                
                // Character overlay is hidden but still used for applying effects
                this.characterOverlay = null;
                
                // Track effects active status
                this.isActive = true;
                console.log("ðŸŽ® Game juice effects initialized - Visual Only Mode");
                
                // Apply direct CSS to document head for immediate effect
                this.injectStyles();
            }
            
            createCharacterOverlay() {
                // We're not creating a visible overlay character anymore
                // but we'll keep this method for compatibility
                return null;
            }
            
            injectStyles() {
                // Add CSS directly to ensure animations work
                const styleEl = document.createElement('style');
                styleEl.textContent = `
                    @keyframes character-squash {
                        0% { transform: scaleY(1) scaleX(1); }
                        50% { transform: scaleY(0.7) scaleX(1.3); }
                        100% { transform: scaleY(1) scaleX(1); }
                    }
                    
                    @keyframes character-stretch {
                        0% { transform: scaleY(1) scaleX(1); }
                        50% { transform: scaleY(1.3) scaleX(0.7); }
                        100% { transform: scaleY(1) scaleX(1); }
                    }
                    
                    @keyframes shake {
                        0%, 100% { transform: translate(0, 0); }
                        10% { transform: translate(-5px, 5px); }
                        20% { transform: translate(5px, -5px); }
                        30% { transform: translate(-6px, -6px); }
                        40% { transform: translate(6px, 6px); }
                        50% { transform: translate(-4px, -4px); }
                        60% { transform: translate(4px, 4px); }
                        70% { transform: translate(-6px, -2px); }
                        80% { transform: translate(2px, -6px); }
                        90% { transform: translate(-5px, 5px); }
                    }
                    
                    .score-popup {
                        position: absolute;
                        font-family: 'Bangers', cursive;
                        color: white;
                        font-size: 30px;
                        text-shadow: 2px 2px 0 #000;
                        pointer-events: none;
                        z-index: 9600;
                        animation: scorePopup 1s forwards;
                    }
                    
                    @keyframes scorePopup {
                        0% { transform: scale(0.5); opacity: 0; }
                        10% { transform: scale(1.2); opacity: 1; }
                        20% { transform: scale(1); opacity: 1; }
                        80% { transform: scale(1) translateY(-20px); opacity: 1; }
                        100% { transform: scale(1) translateY(-30px); opacity: 0; }
                    }
                    
                    .combo-popup {
                        position: absolute;
                        font-family: 'Bangers', cursive;
                        color: #FFD700;
                        font-size: 40px;
                        text-shadow: 2px 2px 0 #000, 0 0 10px rgba(255, 215, 0, 0.7);
                        pointer-events: none;
                        z-index: 9600;
                        animation: comboPopup 1.5s forwards;
                    }
                    
                    @keyframes comboPopup {
                        0% { transform: scale(0.5); opacity: 0; }
                        10% { transform: scale(1.5); opacity: 1; }
                        30% { transform: scale(1.2); opacity: 1; }
                        90% { transform: scale(1.2) translateY(-30px); opacity: 1; }
                        100% { transform: scale(1) translateY(-40px); opacity: 0; }
                    }
                    
                    .particle {
                        position: absolute;
                        pointer-events: none;
                        z-index: 9500;
                        width: 15px;
                        height: 15px;
                        background-color: white;
                        border-radius: 50%;
                        box-shadow: 0 0 10px gold;
                    }
                    
                    .particle.star {
                        clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
                    }
                    
                    .particle.flame {
                        background: linear-gradient(to top, #FF5722, #FFC107);
                        border-radius: 50% 50% 0 50%;
                        transform: rotate(45deg);
                    }
                `;
                document.head.appendChild(styleEl);
            }
            
            // Simplified version that doesn't require sound files
            playSound(soundName) {
                // Audio disabled to prevent errors
                return false;
            }
            
            // Apply squash effect to canvas directly
            applySquash(duration = 300) {
                if (!this.isActive) return;
                console.log("Applying squash effect");
                
                // Apply effect to canvas directly
                if (this.canvas) {
                    this.canvas.style.animation = `character-squash ${duration}ms ease-in-out`;
                    
                    // Reset animation when done
                    setTimeout(() => {
                        this.canvas.style.animation = '';
                    }, duration);
                }
            }
            
            // Apply stretch effect to canvas directly
            applyStretch(duration = 300) {
                if (!this.isActive) return;
                console.log("Applying stretch effect");
                
                // Apply effect to canvas directly
                if (this.canvas) {
                    this.canvas.style.animation = `character-stretch ${duration}ms ease-in-out`;
                    
                    // Reset animation when done
                    setTimeout(() => {
                        this.canvas.style.animation = '';
                    }, duration);
                }
            }
            
            // Screen shake effect
            screenShake(intensity = 5, duration = 300) {
                if (!this.canvas || !this.isActive) return;
                console.log("Applying screen shake");
                
                // Apply to whole document body for more visible effect
                document.body.style.animation = `shake ${duration}ms ease-in-out`;
                setTimeout(() => {
                    document.body.style.animation = '';
                }, duration);
            }
            
            // Score popup animations
            showScorePopup(x, y, value, isCombo = false) {
                if (!this.isActive) return;
                console.log("Showing score popup:", value);
                
                // Fix coordinates if not provided
                if (!x || !y) {
                    const canvasRect = this.canvas ? this.canvas.getBoundingClientRect() : null;
                    x = canvasRect ? canvasRect.left + canvasRect.width / 2 : window.innerWidth / 2;
                    y = canvasRect ? canvasRect.top + canvasRect.height / 2 : window.innerHeight / 2;
                }
                
                const popup = document.createElement('div');
                popup.className = isCombo ? 'combo-popup' : 'score-popup';
                popup.textContent = isCombo ? `+${value} COMBO!` : `+${value}`;
                popup.style.left = `${x}px`;
                popup.style.top = `${y}px`;
                
                document.body.appendChild(popup);
                
                // Remove after animation completes
                setTimeout(() => {
                    popup.remove();
                }, isCombo ? 1500 : 1000);
            }
            
            // Completely empty implementation - no particles at all
            createParticles(x, y, type = 'star', count = 5) {
                // Do nothing - particles disabled for performance
                return null;
            }
        }
        
        // Create global instance of juice effects
        window.juiceEffects = new JuiceEffects();

        // Immediately attach to game when loaded
        window.addEventListener('load', function() {
            console.log("Window loaded, setting up juice effects integration");
            
            // Add keyboard event listeners for immediate feedback
            document.addEventListener('keydown', (e) => {
                // No particle effects for key presses - disabled for performance
            });
        });
    </script>

    <!-- Add this script after the load event script to ensure everything is initialized -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize audio when the DOM is fully loaded
            if (typeof initAudio === 'function') {
                // Initialize audio system
                initAudio();
                console.log('Audio system initialized');
                
                // Make sure audio context is resumed on common user interactions
                const resumeAudioContext = () => {
                    if (window.audioManager && window.audioManager.audioContext) {
                        if (window.audioManager.audioContext.state === 'suspended') {
                            window.audioManager.audioContext.resume().then(() => {
                                console.log('AudioContext resumed by user interaction');
                            });
                        }
                    }
                };
                
                // Add listeners to common interaction events
                ['click', 'touchstart', 'keydown'].forEach(event => {
                    document.addEventListener(event, resumeAudioContext);
                });
                
                // Make sure we're not muted unless explicitly requested
                if (window.setAudioMuted) {
                    // Only set to false if not already set in localStorage
                    if (localStorage.getItem('audioMuted') !== 'true') {
                        window.setAudioMuted(false);
                    }
                }
            } else {
                console.warn('initAudio function not found');
            }
        });
    </script>

    <!-- Add this script right after the audio elements to ensure fall sound is preloaded -->
    <script>
        // Preload fall sound explicitly
        document.addEventListener('DOMContentLoaded', function() {
            // Preload fall sound
            const fallSound = document.getElementById('sound-fall');
            if (fallSound) {
                // Force preload
                fallSound.load();
                console.log('Fall sound preloaded');
                
                // Test the fall sound on page load (will be silent due to browser restrictions)
                fallSound.volume = 0;
                const playPromise = fallSound.play();
                if (playPromise) {
                    playPromise.then(() => {
                        fallSound.pause();
                        fallSound.currentTime = 0;
                        fallSound.volume = 1.0;
                        console.log('Fall sound successfully tested');
                    }).catch(e => {
                        console.warn('Could not test fall sound due to browser restrictions:', e);
                    });
                }
            } else {
                console.warn('Fall sound element not found for preloading');
            }
            
            // Also create and preload a direct Audio object
            const audioFall = new Audio('sound effects/fall.mp3');
            audioFall.preload = 'auto';
            audioFall.load();
            
            // Store it globally for easy access
            window.fallAudio = audioFall;
        });
    </script>

    <!-- Add right after the audio elements to ensure audio is always unmuted -->
    <script>
        // Force unmute audio on game load
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any previously saved mute state
            localStorage.removeItem('audioMuted');
            
            // Unmute all audio elements
            const allAudio = document.querySelectorAll('audio');
            allAudio.forEach(audio => {
                audio.muted = false;
            });
            
            // Set an interval to check and unmute audio periodically
            setInterval(() => {
                // Check if window.audioManager exists
                if (window.audioManager) {
                    // Force audio to be unmuted
                    window.audioManager.setMuted(false);
                    
                    // Tell the parent window about this unmuted state
                    try {
                        window.parent.postMessage({
                            type: 'FORCE_AUDIO_UNMUTE',
                            message: 'Game needs audio to be unmuted'
                        }, '*');
                    } catch (e) {
                        console.warn('Could not send unmute message to parent window:', e);
                    }
                }
                
                // Also unmute any HTML audio elements
                document.querySelectorAll('audio').forEach(audio => {
                    audio.muted = false;
                });
            }, 1000); // Check every second
        });
        
        // Override the mute button behavior in parent window
        window.addEventListener('message', function(event) {
            if (event.data?.type === 'AUDIO_CONTROL_INITIALIZED') {
                // Send a message back to parent to unmute
                try {
                    window.parent.postMessage({
                        type: 'FORCE_AUDIO_UNMUTE',
                        message: 'Game needs audio to be unmuted'
                    }, '*');
                } catch (e) {
                    console.warn('Could not send unmute message to parent window:', e);
                }
            }
        });
    </script>

    <!-- Additional script to play audio on first user interaction -->
    <script>
        // Add this at the very end to ensure it overrides any other behavior
        document.addEventListener('DOMContentLoaded', function() {
            // Create a silent audio for unlocking audio
            const unlockAudio = document.createElement('audio');
            unlockAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjM1LjEwNAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAFAAAC/ABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqr///////////////////////////////////////////8AAAAATGF2YzU4LjU5AAAAAAAAAAAAAAAAJAYHAQAAAAAAn+cDhQAAAAAAAAAAAAAAAAAAAP/7UMQAAApkTrBUyIAB0xWkJZmQASsQE+0+S7kU1jdJwF3BESaz+EUQMVHjZo/CXM9lI5s6YA6v30zpmDP//Ew50fnP/y55Zuc3MduWz///5bu/+cAf//3IEYbO///+oAgGP/////gmO74j//yICI4DgQVAUDw4L///8eCiTFiS4//+AYYYt9HlFX///+SQgXL//EgIE5//+WhfL28XbxdvF28XbxdvF28XbxdvF28XbxdvF28XbxdvF28XbxdvF28X//yYQgE//8ySggQI//8+bJ7Z7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J//8gIgI//8mEQhBP//JrJ7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J7J//8GgBAgCEIGf//xEAACd34pAA0gQCLf//+cAATQ7k8//5MABAtD//pAAB4v//MAAGP//wQAQg///8yACQBQpb//+EAAkCrq///+gAAUCL1///wgAOh////wwAJgAif///KAAJAMov//9AADIBC////CAAeAREf//+aAAWAaJP//+EABsAUS///9AAOhbLO//6IAAjAUG///wgAQD7//9uAACmQFX///tAAQAWEv//+cAACwGRH///XAA8BkKP//+SAACQXRb///1QARgOCf///2QALgZC3///qgAaAMEn//+SAAoAcK///+qABYB4nf///VAAiAkJf///qAAoA0TP///rgAWALlnAAA=';
            unlockAudio.load();
            
            // Function to unlock audio on any user interaction
            const unlockAudioPlayback = () => {
                // Play the silent audio
                const playPromise = unlockAudio.play();
                if (playPromise) {
                    playPromise.then(() => {
                        console.log('Audio playback unlocked by user interaction');
                        
                        // Try to play background music
                        const bgMusic = document.getElementById('bg-music');
                        if (bgMusic) {
                            bgMusic.muted = false;
                            bgMusic.volume = 0.5;
                            bgMusic.play().then(() => {
                                console.log('Background music started playing successfully');
                            }).catch(err => {
                                console.warn('Could not play background music:', err);
                            });
                        }
                        
                        // Also try to use AudioManager if available
                        if (window.audioManager) {
                            window.audioManager.setMuted(false);
                            // If playBackgroundMusic method exists, call it
                            if (typeof window.audioManager.playBackgroundMusic === 'function') {
                                window.audioManager.playBackgroundMusic();
                            }
                        }
                    }).catch(err => {
                        console.warn('Could not unlock audio playback:', err);
                    });
                }
                
                // Remove these event listeners after first interaction
                ['click', 'touchstart', 'keydown'].forEach(evt => {
                    document.removeEventListener(evt, unlockAudioPlayback);
                });
            };
            
            // Add listeners for user interaction
            ['click', 'touchstart', 'keydown'].forEach(evt => {
                document.addEventListener(evt, unlockAudioPlayback);
            });
        });
    </script>

    <!-- Add the game-revive.js script after the other script includes, but before the closing body tag -->
    <!-- Game scripts already included -->
    <script src="js/sound.js"></script>
    <script src="js/player.js"></script>
    <script src="js/platform.js"></script>
    <script src="js/main.js"></script>
    <script src="game-fixes.js"></script>
    
    <!-- Add revive functionality -->
    <script src="game-revive.js"></script>
</body>
</html> 